<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Call LLM APIs from R • elmer</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="apple-touch-icon-60x60.png">
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Call LLM APIs from R">
<meta name="description" content="A consistent interface for calling LLM APIs. Includes support for streaming.">
<meta property="og:description" content="A consistent interface for calling LLM APIs. Includes support for streaming.">
<meta property="og:image" content="https://hadley.github.io/elmer/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">elmer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/hadley/elmer/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header">
<img src="logo.png" class="logo" alt=""><h1 id="elmer-">elmer 
<a class="anchor" aria-label="anchor" href="#elmer-"></a>
</h1>
</div>
<!-- badges: start -->

<p>The goal of elmer is to provide a user friendly wrapper over the most common APIs for calling llm’s. Major design goals include support for streaming and making it easy to register and call R functions.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install the development version of elmer from <a href="https://github.com/" class="external-link">GitHub</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("pak")</span></span>
<span><span class="fu">pak</span><span class="fu">::</span><span class="fu"><a href="https://pak.r-lib.org/reference/pak.html" class="external-link">pak</a></span><span class="op">(</span><span class="st">"hadley/elmer"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<p>To use elmer, you need an OpenAI API key. You can get one from <a href="https://platform.openai.com/account/api-keys" class="external-link">your developer console</a>. Then you should save that value as the <code>OPENAI_API_KEY</code> environment variable in your <code>~/.Renviron</code> (an easy way to open that file is to call <code>usethis::edit_r_environ()</code>).</p>
</div>
<div class="section level2">
<h2 id="using-elmer">Using elmer<a class="anchor" aria-label="anchor" href="#using-elmer"></a>
</h2>
<p>You chat with elmer in several different ways, depending on whether you are working interactively or programmatically. They all start with creating a new chat object:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/elmer" class="external-link">elmer</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_chat_openai.html">new_chat_openai</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="st">"gpt-4o-mini"</span>,</span>
<span>  system_prompt <span class="op">=</span> <span class="st">"You are a friendly but terse assistant."</span>,</span>
<span>  echo <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Chat objects are stateful: they retain the context of the conversation, so each new query can build on the previous ones. This is true regardless of which of the various ways of chatting you use.</p>
<div class="section level3">
<h3 id="interactive-chat-console">Interactive chat console<a class="anchor" aria-label="anchor" href="#interactive-chat-console"></a>
</h3>
<p>The most interactive, least programmatic way of using elmer is to chat with it directly in your R console.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/chat_console.html">chat_console</a></span><span class="op">(</span><span class="va">chat</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>╔════════════════════════════════════════════════════════╗</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>║  Entering chat console. Use <span class="st">""" for multi-line input.  ║</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="st">║  Press Ctrl+C to quit.                                 ║</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="st">╚════════════════════════════════════════════════════════╝</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="st">&gt;&gt;&gt; Who were the original creators of R?</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="st">R was originally created by Ross Ihaka and Robert Gentleman at the University of</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="st">Auckland, New Zealand.</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="st">&gt;&gt;&gt; When was that?</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="st">R was initially released in 1995. Development began a few years prior to that,</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a><span class="st">in the early 1990s.</span></span></code></pre></div>
<p>The chat console is useful for quickly exploring the capabilities of the model, especially when you’ve customized the chat object with tool integrations (see below).</p>
<p>Again, keep in mind that the chat object retains state, so when you enter the chat console, any previous interactions with that chat object are still part of the conversation, and any interactions you have in the chat console will persist even after you exit back to the R prompt.</p>
</div>
<div class="section level3">
<h3 id="interactive-method-call">Interactive method call<a class="anchor" aria-label="anchor" href="#interactive-method-call"></a>
</h3>
<p>The second most interactive way to chat using elmer is to call the <code>chat()</code> method.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="st">"What preceding languages most influenced R?"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>R was primarily influenced by the S programming language, particularly S<span class="sc">-</span>PLUS.</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>Other languages that had an impact include Scheme and various data analysis</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>languages.</span></code></pre></div>
<p>If you initialize the chat object with <code>echo = TRUE</code>, as we did above, the <code>chat</code> method streams the response to the console as it arrives. When the entire response is received, it is returned as a character vector (invisibly, so it’s not printed twice).</p>
<p>This mode is useful when you want to see the response as it arrives, but you don’t want to enter the chat console.</p>
<div class="section level4">
<h4 id="vision-image-input">Vision (image input)<a class="anchor" aria-label="anchor" href="#vision-image-input"></a>
</h4>
<p>If you want to ask a question about an image, you can pass one or more additional input arguments using <code><a href="reference/content_image_url.html">content_image_file()</a></code> and/or <code><a href="reference/content_image_url.html">content_image_url()</a></code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="reference/content_image_url.html">content_image_url</a></span><span class="op">(</span><span class="st">"https://www.r-project.org/Rlogo.png"</span><span class="op">)</span>,</span>
<span>  <span class="st">"Can you explain this logo?"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>The logo of R features a stylized letter <span class="st">"R"</span> <span class="cf">in</span> blue, enclosed <span class="cf">in</span> an oval shape that resembles the letter <span class="st">"O,"</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>signifying the programming language<span class="st">'s name. The design conveys a modern and professional look, reflecting its use</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="st">in statistical computing and data analysis. The blue color often represents trust and reliability, which aligns</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="st">with R'</span>s role <span class="cf">in</span> data science.</span></code></pre></div>
<p>The <code>content_image_url</code> function takes a URL to an image file and sends that URL directly to the API. The <code>content_image_file</code> function takes a path to a local image file and encodes it as a base64 string to send to the API. Note that by default, <code>content_image_file</code> automatically resizes the image to fit within 512x512 pixels; set the <code>resize</code> parameter to <code>"high"</code> if higher resolution is needed.</p>
</div>
</div>
<div class="section level3">
<h3 id="programmatic-chat">Programmatic chat<a class="anchor" aria-label="anchor" href="#programmatic-chat"></a>
</h3>
<p>If you don’t want to see the response as it arrives, you can turn off echoing by leaving off the <code>echo = TRUE</code> argument to <code><a href="reference/new_chat_openai.html">new_chat_openai()</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_chat_openai.html">new_chat_openai</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="st">"gpt-4o-mini"</span>,</span>
<span>  system_prompt <span class="op">=</span> <span class="st">"You are a friendly but terse assistant."</span></span>
<span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="st">"Is R a functional programming language?"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"Yes, R supports functional programming concepts. It allows functions to be first-class objects, supports higher-order functions, and encourages the use of functions as core components of code. However, it also supports procedural and object-oriented programming styles."</span></span></code></pre></div>
<p>This mode is useful for programming using elmer, when the result is either not intended for human consumption or when you want to process the response before displaying it.</p>
</div>
<div class="section level3">
<h3 id="streaming-results">Streaming results<a class="anchor" aria-label="anchor" href="#streaming-results"></a>
</h3>
<p>The <code>chat()</code> method does not return any results until the entire response has been received. (It can <em>print</em> the streaming results to the console, but it <em>returns</em> the result only when the response is complete.)</p>
<p>If you want to process the response as it arrives, you can use the <code>stream()</code> method. This may be useful when you want to display the response in realtime, but somewhere other than the R console (like writing to a file, or an HTTP response, or a Shiny chat window); or when you want to manipulate the response before displaying it, without giving up the immediacy of streaming.</p>
<p>The <code>stream()</code> method returns a <a href="https://coro.r-lib.org/articles/generator.html" class="external-link">generator</a> from the <a href="https://coro.r-lib.org/" class="external-link">coro package</a>, which you can loop over to process the response as it arrives.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stream</span> <span class="op">&lt;-</span> <span class="va">chat</span><span class="op">$</span><span class="fu">stream</span><span class="op">(</span><span class="st">"What are some common uses of R?"</span><span class="op">)</span></span>
<span><span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/collect.html" class="external-link">loop</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">chunk</span> <span class="kw">in</span> <span class="va">stream</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>R IS COMMONLY USED FOR<span class="sc">:</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="fl">1.</span> <span class="sc">**</span>STATISTICAL ANALYSIS<span class="sc">**</span><span class="er">:</span> PERFORMING COMPLEX STATISTICAL TESTS AND ANALYSES.</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="fl">2.</span> <span class="sc">**</span>DATA VISUALIZATION<span class="sc">**</span><span class="er">:</span> CREATING GRAPHS, CHARTS, AND PLOTS USING PACKAGES LIKE GGPLOT2.</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="fl">3.</span> <span class="sc">**</span>DATA MANIPULATION<span class="sc">**</span><span class="er">:</span> CLEANING AND TRANSFORMING DATA WITH PACKAGES LIKE DPLYR AND TIDYR.</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="fl">4.</span> <span class="sc">**</span>MACHINE LEARNING<span class="sc">**</span><span class="er">:</span> BUILDING PREDICTIVE MODELS WITH LIBRARIES LIKE CARET AND RANDOMFOREST.</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="fl">5.</span> <span class="sc">**</span>BIOINFORMATICS<span class="sc">**</span><span class="er">:</span> ANALYZING BIOLOGICAL DATA AND GENOMIC STUDIES.</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="fl">6.</span> <span class="sc">**</span>ECONOMETRICS<span class="sc">**</span><span class="er">:</span> PERFORMING ECONOMIC DATA ANALYSIS AND MODELING.</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="fl">7.</span> <span class="sc">**</span>REPORTING<span class="sc">**</span><span class="er">:</span> GENERATING DYNAMIC REPORTS AND DASHBOARDS WITH R MARKDOWN.</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a><span class="fl">8.</span> <span class="sc">**</span>TIME SERIES ANALYSIS<span class="sc">**</span><span class="er">:</span> ANALYZING TEMPORAL DATA AND FORECASTING.</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>THESE USES MAKE R A POWERFUL TOOL FOR DATA SCIENTISTS, STATISTICIANS, AND RESEARCHERS.</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="async-usage-advanced">Async usage (Advanced)<a class="anchor" aria-label="anchor" href="#async-usage-advanced"></a>
</h2>
<p>elmer also supports async usage, which is useful when you want to run multiple chat sessions concurrently. This is primarily useful in Shiny applications, where using the methods described above would block the Shiny app for other users for the duration of each response.</p>
<p>To use async chat, instead of <code>chat()</code>/<code>stream()</code>, call <code>chat_async()</code>/<code>stream_async()</code>. The <code>_async</code> variants take the same arguments for construction, but return promises instead of the actual response.</p>
<p>Remember that chat objects are stateful, maintaining the conversation history as you interact with it. Note that this means it doesn’t make sense to issue multiple chat/stream operations on the same chat object concurrently, as the conversation history could become corrupted with interleaved conversation fragments. If you need to run multiple chat sessions concurrently, create multiple chat objects.</p>
<div class="section level3">
<h3 id="asynchronous-chat">Asynchronous chat<a class="anchor" aria-label="anchor" href="#asynchronous-chat"></a>
</h3>
<p>For asynchronous, non-streaming chat, you use the <code>chat()</code> method as before, but handle the result as a promise instead of a string.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/promises/" class="external-link">promises</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat_async</span><span class="op">(</span><span class="st">"How's your day going?"</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>I<span class="st">'m just a computer program, so I don'</span>t have feelings, but I<span class="st">'m here to help you with any questions you have.</span></span></code></pre></div>
<p>TODO: Shiny example</p>
</div>
<div class="section level3">
<h3 id="asynchronous-streaming">Asynchronous streaming<a class="anchor" aria-label="anchor" href="#asynchronous-streaming"></a>
</h3>
<p>For asynchronous streaming, you use the <code>stream()</code> method as before, but the result is a <a href="https://coro.r-lib.org/reference/async_generator.html" class="external-link">async generator</a> from the <a href="https://coro.r-lib.org/" class="external-link">coro package</a>. This is the same as a regular <a href="https://coro.r-lib.org/articles/generator.html" class="external-link">generator</a>, except instead of giving you strings, it gives you promises that resolve to strings.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stream</span> <span class="op">&lt;-</span> <span class="va">chat</span><span class="op">$</span><span class="fu">stream_async</span><span class="op">(</span><span class="st">"What are some common uses of R?"</span><span class="op">)</span></span>
<span><span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coro/man/async.html" class="external-link">async</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">chunk</span> <span class="kw">in</span> <span class="fu">await_each</span><span class="op">(</span><span class="va">stream</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="sc">&lt;</span>Promise [pending]<span class="sc">&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="er">&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>R IS COMMONLY USED FOR<span class="sc">:</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="fl">1.</span> <span class="sc">**</span>STATISTICAL ANALYSIS<span class="sc">**</span><span class="er">:</span> PERFORMING VARIOUS STATISTICAL TESTS AND MODELS.</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="fl">2.</span> <span class="sc">**</span>DATA VISUALIZATION<span class="sc">**</span><span class="er">:</span> CREATING PLOTS AND GRAPHS TO VISUALIZE DATA.</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a><span class="fl">3.</span> <span class="sc">**</span>DATA MANIPULATION<span class="sc">**</span><span class="er">:</span> CLEANING AND TRANSFORMING DATA WITH PACKAGES LIKE DPLYR.</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a><span class="fl">4.</span> <span class="sc">**</span>MACHINE LEARNING<span class="sc">**</span><span class="er">:</span> BUILDING PREDICTIVE MODELS AND ALGORITHMS.</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="fl">5.</span> <span class="sc">**</span>BIOINFORMATICS<span class="sc">**</span><span class="er">:</span> ANALYZING BIOLOGICAL DATA, ESPECIALLY IN GENOMICS.</span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a><span class="fl">6.</span> <span class="sc">**</span>TIME SERIES ANALYSIS<span class="sc">**</span><span class="er">:</span> ANALYZING TEMPORAL DATA FOR TRENDS AND FORECASTS.</span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a><span class="fl">7.</span> <span class="sc">**</span>REPORT GENERATION<span class="sc">**</span><span class="er">:</span> CREATING DYNAMIC REPORTS WITH R MARKDOWN.</span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a><span class="fl">8.</span> <span class="sc">**</span>GEOSPATIAL ANALYSIS<span class="sc">**</span><span class="er">:</span> MAPPING AND ANALYZING GEOGRAPHIC DATA.</span></code></pre></div>
<p>Async generators are very advanced, and require a good understanding of asynchronous programming in R. They are also the only way to present streaming results in Shiny without blocking other users. Fortunately, Shiny will soon have chat components that will make this easier, where you can simply hand the result of <code>stream_async()</code> to a chat output.</p>
</div>
</div>
<div class="section level2">
<h2 id="tool-calling-aka-function-calling">Tool calling (a.k.a. function calling)<a class="anchor" aria-label="anchor" href="#tool-calling-aka-function-calling"></a>
</h2>
<p>One of the most interesting aspects of modern chat models is their ability to make use of external tools that are defined by the caller.</p>
<p>When making a chat request to the chat model, the caller advertises one or more tools (defined by their function name, description, and a list of expected arguments), and the chat model can choose to respond with one or more “tool calls”. These tool calls are requests <em>from the chat model to the caller</em> to execute the function with the given arguments; the caller is expected to execute the functions and “return” the results by submitting another chat request with the conversation so far, plus the results. The chat model can then use those results in formulating its response, or, it may decide to make additional tool calls.</p>
<p><em>Note that the chat model does not directly execute any external tools!</em> It only makes requests for the caller to execute them. The value that the chat model brings is not in helping with execution, but with knowing when it makes sense to call a tool, what values to pass as arguments, and how to use the results in formulating its response.</p>
<div class="section level3">
<h3 id="motivating-example">Motivating example<a class="anchor" aria-label="anchor" href="#motivating-example"></a>
</h3>
<p>Let’s take a look at an example where we really need an external tool. Chat models generally do not know the current time, which makes questions like these impossible.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_chat_openai.html">new_chat_openai</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"gpt-4o"</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="st">"How long ago exactly was the moment Neil Armstrong touched down on the moon?"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>Neil Armstrong touched down on the moon on July <span class="dv">20</span>, <span class="dv">1969</span>, at <span class="dv">20</span><span class="sc">:</span><span class="dv">17</span> UTC. To determine how long ago that</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>was from the current year of <span class="dv">2023</span>, we can calculate the difference <span class="cf">in</span> years, months, and days.</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>From July <span class="dv">20</span>, <span class="dv">1969</span>, to July <span class="dv">20</span>, <span class="dv">2023</span>, is exactly <span class="dv">54</span> years. If today<span class="st">'s date is after July 20, 2023, you</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a><span class="st">would add the additional time since then. If it is before, you would consider slightly less than 54</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a><span class="st">years.</span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a><span class="st">As of right now, can you confirm the current date so we can calculate the precise duration?</span></span></code></pre></div>
<p>Unfortunately, this example was run on September 18, 2024. Let’s give the chat model the ability to determine the current time and try again.</p>
</div>
<div class="section level3">
<h3 id="defining-a-tool-function">Defining a tool function<a class="anchor" aria-label="anchor" href="#defining-a-tool-function"></a>
</h3>
<p>The first thing we’ll do is define an R function that returns the current time. This will be our tool.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Gets the current time in the given time zone.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param tz The time zone to get the current time in.</span></span>
<span><span class="co">#' @return The current time in the given time zone.</span></span>
<span><span class="va">get_current_time</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tz</span> <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, tz <span class="op">=</span> <span class="va">tz</span>, usetz <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note that we’ve gone through the trouble of creating <a href="https://roxygen2.r-lib.org/" class="external-link">roxygen2 comments</a>. This is a very important step that will help the model use your tool correctly!</p>
<p>Let’s test it:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">get_current_time</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"2024-09-18 17:47:14 UTC"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="registering-tools">Registering tools<a class="anchor" aria-label="anchor" href="#registering-tools"></a>
</h3>
<p>Now we need to tell our chat object about our <code>get_current_time</code> function. This is done using the <code>register_tool()</code> method.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_chat_openai.html">new_chat_openai</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"gpt-4o"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">register_tool</span><span class="op">(</span></span>
<span>  fun <span class="op">=</span> <span class="va">get_current_time</span>,</span>
<span>  description <span class="op">=</span> <span class="st">"Gets the current time in the given time zone."</span>,</span>
<span>  arguments <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    tz <span class="op">=</span> <span class="fu"><a href="reference/tool_arg.html">tool_arg</a></span><span class="op">(</span></span>
<span>      type <span class="op">=</span> <span class="st">"string"</span>,</span>
<span>      description <span class="op">=</span> <span class="st">"The time zone to get the current time in. Defaults to `\"UTC\"`."</span>,</span>
<span>      required <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This is a fair amount of code to write, even for such a simple function as <code>get_current_time</code>. Fortunately, you don’t have to write this by hand! I generated the above <code>register_tool</code> call by calling <code>create_tool_metadata(get_current_time)</code>, which printed that code at the console. <code><a href="reference/create_tool_metadata.html">create_tool_metadata()</a></code> works by passing the function’s signature and documentation to GPT-4o, and asking it to generate the <code>register_tool</code> call for you.</p>
<p>Note that <code><a href="reference/create_tool_metadata.html">create_tool_metadata()</a></code> may not create perfect results, so you must review the generated code before using it. But it is a huge time-saver nonetheless, and removes the tedious boilerplate generation you’d have to do otherwise.</p>
</div>
<div class="section level3">
<h3 id="using-the-tool">Using the tool<a class="anchor" aria-label="anchor" href="#using-the-tool"></a>
</h3>
<p>That’s all we need to do! Let’s retry our query:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="st">"How long ago exactly was the moment Neil Armstrong touched down on the moon?"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>Neil Armstrong touched down on the moon on July <span class="dv">20</span>, <span class="dv">1969</span>, at <span class="dv">20</span><span class="sc">:</span><span class="dv">17</span> UTC.</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>To calculate the time elapsed from that moment until the current <span class="fu">time</span> (September <span class="dv">18</span>, <span class="dv">2024</span>, <span class="dv">17</span><span class="sc">:</span><span class="dv">47</span><span class="sc">:</span><span class="dv">19</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>UTC), we need to <span class="cf">break</span> it down.</span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a><span class="fl">1.</span> From July <span class="dv">20</span>, <span class="dv">1969</span>, <span class="dv">20</span><span class="sc">:</span><span class="dv">17</span> UTC to July <span class="dv">20</span>, <span class="dv">2024</span>, <span class="dv">20</span><span class="sc">:</span><span class="dv">17</span> UTC is exactly <span class="dv">55</span> years.</span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a><span class="fl">2.</span> From July <span class="dv">20</span>, <span class="dv">2024</span>, <span class="dv">20</span><span class="sc">:</span><span class="dv">17</span> UTC to September <span class="dv">18</span>, <span class="dv">2024</span>, <span class="dv">17</span><span class="sc">:</span><span class="dv">47</span><span class="sc">:</span><span class="dv">19</span> UTC, we need to further <span class="cf">break</span> down<span class="sc">:</span></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>   <span class="sc">-</span> From July <span class="dv">20</span>, <span class="dv">2024</span>, <span class="dv">20</span><span class="sc">:</span><span class="dv">17</span> UTC to September <span class="dv">18</span>, <span class="dv">2024</span>, <span class="dv">17</span><span class="sc">:</span><span class="dv">47</span><span class="sc">:</span><span class="dv">19</span> UTC, which is<span class="sc">:</span></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a>     <span class="sc">-</span> <span class="dv">1</span> full <span class="fu">month</span> (August)</span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a>     <span class="sc">-</span> <span class="dv">30</span> – <span class="dv">20</span> <span class="ot">=</span> <span class="dv">10</span> days of July</span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a>     <span class="sc">-</span> <span class="dv">18</span> days of September until <span class="dv">17</span><span class="sc">:</span><span class="dv">47</span><span class="sc">:</span><span class="dv">19</span> UTC</span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a>So, <span class="cf">in</span> detail<span class="sc">:</span></span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a>   <span class="sc">-</span> <span class="dv">55</span> years</span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a>   <span class="sc">-</span> <span class="dv">1</span> month</span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a>   <span class="sc">-</span> <span class="dv">28</span> days</span>
<span id="cb24-18"><a href="#cb24-18" tabindex="-1"></a>   <span class="sc">-</span> From July <span class="dv">20</span>, <span class="dv">2024</span>, <span class="dv">20</span><span class="sc">:</span><span class="dv">17</span> UTC to July <span class="dv">20</span>, <span class="dv">2024</span>, <span class="dv">17</span><span class="sc">:</span><span class="dv">47</span><span class="sc">:</span><span class="dv">19</span> UTC<span class="sc">:</span> <span class="dv">23</span> hours, <span class="dv">30</span> minutes, and <span class="dv">19</span> seconds</span>
<span id="cb24-19"><a href="#cb24-19" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" tabindex="-1"></a>Time Total<span class="sc">:</span></span>
<span id="cb24-21"><a href="#cb24-21" tabindex="-1"></a><span class="sc">-</span> <span class="dv">55</span> years</span>
<span id="cb24-22"><a href="#cb24-22" tabindex="-1"></a><span class="sc">-</span> <span class="dv">1</span> month</span>
<span id="cb24-23"><a href="#cb24-23" tabindex="-1"></a><span class="sc">-</span> <span class="dv">28</span> days</span>
<span id="cb24-24"><a href="#cb24-24" tabindex="-1"></a><span class="sc">-</span> <span class="dv">23</span> hours</span>
<span id="cb24-25"><a href="#cb24-25" tabindex="-1"></a><span class="sc">-</span> <span class="dv">30</span> minutes</span>
<span id="cb24-26"><a href="#cb24-26" tabindex="-1"></a><span class="sc">-</span> <span class="dv">19</span> seconds</span>
<span id="cb24-27"><a href="#cb24-27" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" tabindex="-1"></a>This is the exact time that has elapsed since Neil Armstrong<span class="st">'s historic touchdown on the moon.</span></span></code></pre></div>
<p>That’s correct! Without any further guidance, the chat model decided to call our tool function and successfully used its result in formulating its response.</p>
<p>(Full disclosure: I originally tried this example with the default model of <code>gpt-4o-mini</code> and it got the tool calling right but the date math wrong, hence the explicit <code>model="gpt-4o"</code>.)</p>
<p>This tool example was extremely simple, but you can imagine doing much more interesting things from tool functions: calling APIs, reading from or writing to a database, kicking off a complex simulation, or even calling a complementary GenAI model (like an image generator). Or if you are using elmer in a Shiny app, you could use tools to set reactive values, setting off a chain of reactive updates.</p>
</div>
<div class="section level3">
<h3 id="tool-limitations">Tool limitations<a class="anchor" aria-label="anchor" href="#tool-limitations"></a>
</h3>
<p>Remember that tool arguments come from the chat model, and tool results are returned to the chat model. That means that only simple, <a href="https://jeroen.r-universe.dev/jsonlite" class="external-link">jsonlite</a> compatible data types can be used as inputs and outputs. It’s highly recommended that you stick to strings/character, numbers, booleans/logical, null, and named or unnamed lists of those types. And you can forget about using functions, environments, external pointers, R6 classes, and other complex R objects as arguments or return values. Returning data frames seems to work OK, although be careful not to return too much data, as it all counts as tokens (i.e., they count against your context window limit and also cost you money).</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/hadley/elmer/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/hadley/elmer/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing elmer</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Hadley Wickham <br><small class="roles"> Author, maintainer </small>  </li>
<li>Posit Software, PBC <br><small class="roles"> Copyright holder, funder </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/hadley/elmer/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/hadley/elmer/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Hadley Wickham, Posit Software, PBC.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
